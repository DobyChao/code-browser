<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»£ç ä»“åº“æµè§ˆå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    <style>
        :root { --main-bg: #1a202c; --card-bg: #2d3748; --border-color: #4a5568; --text-color: #e2e8f0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--main-bg); color: var(--text-color); }
        .container { max-width: 1600px; margin: auto; padding: 1.5rem; }
        .header { border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .card { background-color: var(--card-bg); border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        pre[class*="language-"] { border-radius: 0.5rem; border: none; padding: 1rem; margin: 0; font-size: 0.875rem; cursor: text; }
        .line-highlight { background: rgba(255, 255, 255, 0.1); display: inline; }
        .file-tree { list-style: none; padding: 0; margin: 0; font-size: 0.9rem; }
        .tree-item { cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 0.25rem; display: flex; align-items: center; user-select: none; white-space: nowrap; }
        .tree-item:hover { background-color: var(--border-color); }
        .tree-item.selected { background-color: #4c51bf; color: white; }
        .tree-item .icon { margin-right: 0.5rem; width: 1rem; text-align: center; }
        .tree-item .toggle { display: inline-block; transition: transform 0.1s ease-in-out; }
        .tree-item.expanded > .toggle { transform: rotate(90deg); }
        .nested-tree { list-style: none; padding-left: 1.5rem; display: none; }
        .tree-item.expanded + .nested-tree { display: block; }
        .search-result:hover { background-color: var(--border-color); }
        .icon-btn { cursor: pointer; padding: 0.25rem; border-radius: 0.25rem; }
        .icon-btn:hover { background-color: var(--border-color); }
        .custom-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23e2e8f0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.4-5.4-13z%22/%3E%3C/svg%3E');
            background-repeat: no-repeat;
            background-position: right .7rem top 50%;
            background-size: .65rem auto;
        }
        .search-highlight {
            background-color: #fcd34d;
            color: #1f2937;
            border-radius: 0.125rem;
            padding: 0 0.125rem;
        }
        /* ä¸ºå¯ç‚¹å‡»çš„ä»£ç æ·»åŠ æ ·å¼æç¤º */
        .code-clickable {
            cursor: pointer;
            text-decoration: underline;
        }
        #toast {
            visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 50; left: 50%; bottom: 30px; font-size: 17px; opacity: 0; transition: opacity 0.5s;
        }
        #toast.show { visibility: visible; opacity: 1; }
    </style>
</head>
<body class="antialiased">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <div class="container">
        <header class="header">
            <div><h1 class="text-3xl font-bold text-gray-200">ä»£ç ä»“åº“æµè§ˆå™¨</h1></div>
            <div class="flex gap-2 items-center">
                <a href="/admin.html" target="_blank" class="icon-btn text-gray-400 hover:text-white" title="è¿›å…¥ç®¡ç†åå°">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                </a>
                <div id="settings-btn" class="icon-btn" title="è®¾ç½®åç«¯æœåŠ¡åœ°å€"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></div>
            </div>
        </header>

        <div class="card p-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="md:col-span-1"><label for="repo-select" class="block text-sm font-medium text-gray-400">é€‰æ‹©ä»“åº“</label><select id="repo-select" class="mt-1 block w-full custom-select pl-3 pr-10 py-2 text-base bg-gray-700 border-gray-600 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md text-white"></select></div>
                <div class="md:col-span-2">
                    <label for="content-search-input" class="block text-sm font-medium text-gray-400">ä»£ç å†…å®¹æœç´¢</label>
                    <div class="mt-1 flex">
                        <select id="search-engine-select" class="custom-select pl-3 pr-8 py-2 text-base bg-gray-800 border-gray-600 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-l-md text-white">
                            <option value="zoekt">Zoekt (ç´¢å¼•)</option>
                            <option value="ripgrep">Ripgrep (å®æ—¶)</option>
                        </select>
                        <input type="text" id="content-search-input" class="flex-1 min-w-0 block w-full px-3 py-2 rounded-none sm:text-sm bg-gray-700 border-gray-600 text-white" placeholder="åœ¨å½“å‰ä»“åº“æœç´¢...">
                        <button id="content-search-button" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-r-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">æœç´¢</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 md:col-span-3 flex flex-col h-[75vh]">
                <div class="mb-2 flex-shrink-0 flex items-center gap-2">
                    <input type="text" id="file-search-input" class="block w-full px-3 py-2 rounded-md sm:text-sm bg-gray-800 border-gray-600 text-white" placeholder="Go to file...">
                    <button id="focus-file-btn" class="p-2 rounded-md bg-gray-800 hover:bg-gray-700 icon-btn" title="åœ¨æ–‡ä»¶æ ‘ä¸­å®šä½å½“å‰æ–‡ä»¶"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg></button>
                </div>
                <div id="list-panel" class="card flex-grow overflow-auto p-2"></div>
            </div>
            <div class="col-span-12 md:col-span-9 flex flex-col h-[75vh]">
                <div class="mb-2 flex-shrink-0"><input type="text" id="file-path-input" class="block w-full px-3 py-2 rounded-md sm:text-sm bg-gray-800 border-gray-600 text-white" placeholder="æ–‡ä»¶ç›¸å¯¹è·¯å¾„..."></div>
                <div class="card flex-grow overflow-auto"><pre id="file-content-pre" style="display: none;"><code id="file-content-code" class="language-plaintext"></code></pre><div id="file-content-placeholder" class="p-8 text-gray-500 text-center flex items-center justify-center h-full">è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶è¿›è¡ŒæŸ¥çœ‹<br><span class="text-sm text-gray-600">(æŒ‰ä½ Ctrl + ç‚¹å‡»ä»£ç å¯è·³è½¬åˆ°å®šä¹‰)</span></div></div>
            </div>
        </div>
        <div id="toast"></div>
    </div>

    <script>
        const App = (() => {
            // --- 1. STATE MANAGEMENT ---
            const state = {
                currentRepoId: '',
                currentFilePath: null,
                selectedFileElement: null,
                fileSearchDebounceTimer: null,
            };

            // --- 2. DOM ELEMENTS ---
            const dom = {
                repoSelect: document.getElementById('repo-select'),
                searchEngineSelect: document.getElementById('search-engine-select'),
                fileSearchInput: document.getElementById('file-search-input'),
                contentSearchInput: document.getElementById('content-search-input'),
                contentSearchButton: document.getElementById('content-search-button'),
                listPanel: document.getElementById('list-panel'),
                fileContentPre: document.getElementById('file-content-pre'),
                fileContentCode: document.getElementById('file-content-code'),
                fileContentPlaceholder: document.getElementById('file-content-placeholder'),
                settingsBtn: document.getElementById('settings-btn'),
                focusFileBtn: document.getElementById('focus-file-btn'),
                filePathInput: document.getElementById('file-path-input'),
                toast: document.getElementById('toast'),
            };

            // --- 3. API CALLS ---
            const api = {
                BASE_URL: localStorage.getItem('apiBaseUrl') || 'http://localhost:8088/api',
                setBaseUrl(url) {
                    this.BASE_URL = url;
                    localStorage.setItem('apiBaseUrl', url);
                },
                async get(endpoint) {
                    const response = await fetch(`${this.BASE_URL}${endpoint}`);
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                    }
                    const contentType = response.headers.get("content-type");
                    return contentType && contentType.includes("application/json") ? response.json() : response.text();
                },
                async post(endpoint, data) {
                    const response = await fetch(`${this.BASE_URL}${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                    }
                    return response.json();
                },
                getRepositories: () => api.get('/repositories'),
                getTree: (repoId, path = '') => api.get(`/repositories/${repoId}/tree?path=${encodeURIComponent(path)}`),
                getBlob: (repoId, path) => api.get(`/repositories/${repoId}/blob?path=${encodeURIComponent(path)}`),
                searchContent: (repoId, query, engine) => api.get(`/repositories/${repoId}/search?q=${encodeURIComponent(query)}&engine=${engine}`),
                searchFiles: (repoId, query, engine) => api.get(`/repositories/${repoId}/search-files?q=${encodeURIComponent(query)}&engine=${engine}`),
                // â˜…â˜…â˜… é€‚é…æ–°çš„åˆ†æè·¯ç”± â˜…â˜…â˜…
                getDefinition: (repoId, filePath, line, character) => api.post('/intelligence/definitions', {repoId, filePath, line, character}),
                getReferences: (repoId, filePath, line, character) => api.post('/intelligence/references', {repoId, filePath, line, character}),
            };

            // --- 4. RENDER FUNCTIONS ---
            const render = {
                repositories(repos) {
                    dom.repoSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>' + 
                        repos.map(repo => `<option value="${repo.id}">${repo.name}</option>`).join('');
                },
                tree(items) {
                    if (!Array.isArray(items) || items.length === 0) {
                        return '<li class="p-2 text-gray-500 text-xs italic">(ç©ºç›®å½•)</li>';
                    }
                    items.sort((a, b) => (a.type === b.type) ? a.name.localeCompare(b.name) : (a.type === 'directory' ? -1 : 1));
                    return items.map(item => `
                        <li>
                            <div class="tree-item" data-path="${item.path}" data-type="${item.type}">
                                <span class="icon">${item.type === 'directory' ? '<span class="toggle">â–º</span>' : '&nbsp;'}</span>
                                <span class="mr-2">${item.type === 'directory' ? 'ğŸ“' : 'ğŸ“„'}</span>
                                <span>${utils.escapeHtml(item.name)}</span>
                            </div>
                        </li>
                    `).join('');
                },
                fileContent(content, path) {
                    dom.fileContentPlaceholder.style.display = 'none';
                    dom.fileContentPre.style.display = 'block';
                    const lang = utils.getLanguageFromPath(path);
                    dom.fileContentCode.className = `language-${lang}`;
                    // å…ˆè®¾ç½®æ–‡æœ¬å†…å®¹ï¼Œä¿æŒåŸæœ‰æ ¼å¼
                    dom.fileContentCode.textContent = content;
                    dom.filePathInput.value = path;
                    // æ ¸å¿ƒä¿®å¤ï¼šæ˜¾å¼è°ƒç”¨ Prism é«˜äº®å½“å‰å…ƒç´ 
                    if (window.Prism) {
                        Prism.highlightElement(dom.fileContentCode);
                    }
                },
                contentSearchResults(results) {
                    if (!results || results.length === 0) {
                        return render.backButton() + render.noResults();
                    }
                    return render.backButton() + results.map(r => {
                        // ä½¿ç”¨æ–°çš„ highlightFragments è¾…åŠ©å‡½æ•°
                        const highlightedText = utils.highlightFragments(r.lineText, r.fragments);
                        return `
                        <div class="search-result p-2 my-1 rounded-md cursor-pointer" data-path="${utils.escapeHtml(r.path)}" data-line="${r.lineNum}">
                            <div class="text-sm font-medium text-indigo-400 truncate">${utils.escapeHtml(r.path)}</div>
                            <div class="text-xs text-gray-400">è¡Œå·: ${r.lineNum}</div>
                            <!-- ä½¿ç”¨ innerHTML æ¸²æŸ“é«˜äº®åçš„ HTML -->
                            <pre class="mt-1 w-full whitespace-pre-wrap"><code class="text-sm">${highlightedText}</code></pre>
                        </div>
                        `;
                    }).join('');
                },
                fileSearchResults(results) {
                    if (!results || results.length === 0) {
                        return render.backButton() + render.noResults();
                    }
                    return render.backButton() + results.map(p => `
                        <div class="tree-item" data-path="${p}" data-type="file">
                            <span class="icon">&nbsp;</span>
                            <span class="mr-2">ğŸ“„</span>
                            <span>${utils.escapeHtml(p)}</span>
                        </div>
                    `).join('');
                },
                status(message) {
                    dom.listPanel.innerHTML = `<div class="p-2 text-gray-500">${message}</div>`;
                },
                backButton: () => `<div class="tree-item" data-action="back-to-tree">â†©ï¸ è¿”å›æ–‡ä»¶æ ‘æµè§ˆ</div>`,
                noResults: () => `<div class="p-2 text-gray-500">æœªæ‰¾åˆ°ç»“æœã€‚</div>`,
                toast(message) {
                    dom.toast.textContent = message;
                    // â˜…â˜…â˜… ä¿®å¤: ä½¿ç”¨ classList æ“ä½œï¼Œæ›´å®‰å…¨ â˜…â˜…â˜…
                    dom.toast.classList.add("show");
                    setTimeout(() => { 
                        dom.toast.classList.remove("show"); 
                    }, 3000);
                }
            };

            // --- 5. LOGIC / EVENT HANDLERS ---
            async function handleRepoChange() {
                state.currentRepoId = dom.repoSelect.value;
                if (state.currentRepoId) {
                    await loadAndRenderRootTree();
                } else {
                    render.status('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä»“åº“');
                    utils.clearFileContent();
                }
            }

            async function loadAndRenderRootTree() {
                render.status('æ­£åœ¨åŠ è½½...');
                try {
                    const items = await api.getTree(state.currentRepoId, '');
                    dom.listPanel.innerHTML = `<ul class="file-tree">${render.tree(items)}</ul>`;
                } catch (error) {
                    console.error('åŠ è½½æ–‡ä»¶æ ‘å¤±è´¥:', error);
                    render.status(`åŠ è½½å¤±è´¥: ${error.message}`);
                }
            }
            
            async function loadFileContent(path, highlightLine = null) {
                render.fileContent('æ­£åœ¨åŠ è½½æ–‡ä»¶...', path);
                state.currentFilePath = path;
                try {
                    const content = await api.getBlob(state.currentRepoId, path);
                    render.fileContent(content, path);
                    if (highlightLine) {
                        setTimeout(() => utils.scrollToLine(highlightLine), 100);
                    }
                } catch (error) {
                    console.error('åŠ è½½æ–‡ä»¶å†…å®¹å¤±è´¥:', error);
                    render.fileContent(`åŠ è½½æ–‡ä»¶å†…å®¹å¤±è´¥: ${error.message}`, path);
                    state.currentFilePath = null;
                }
            }

            async function expandTreeToPath(path) {
                if (!path) return;
                await loadAndRenderRootTree();
                const pathParts = path.split('/').filter(p => p);
                pathParts.pop();

                let currentPath = '';
                for (const part of pathParts) {
                    currentPath += (currentPath ? '/' : '') + part;
                    const dirElement = dom.listPanel.querySelector(`.tree-item[data-path="${currentPath}"][data-type="directory"]`);
                    if (dirElement && !dirElement.classList.contains('expanded')) {
                        await handleDirClick(dirElement, currentPath, false);
                    }
                }
                
                const fileElement = dom.listPanel.querySelector(`.tree-item[data-path="${path}"]`);
                if (fileElement) {
                    utils.updateSelection(fileElement);
                    fileElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }

            async function handleDirClick(dirElement, path, shouldToggle = true) {
                if (shouldToggle) {
                    dirElement.classList.toggle('expanded');
                } else {
                    dirElement.classList.add('expanded');
                }
                
                const isExpanded = dirElement.classList.contains('expanded');
                let nestedUl = dirElement.parentElement.querySelector('.nested-tree');

                if (isExpanded && !nestedUl) {
                    const icon = dirElement.querySelector('.toggle');
                    if(icon) icon.textContent = 'â€¦';
                    try {
                        const items = await api.getTree(state.currentRepoId, path);
                        nestedUl = document.createElement('ul');
                        nestedUl.className = 'nested-tree';
                        nestedUl.innerHTML = render.tree(items);
                        dirElement.parentElement.appendChild(nestedUl);
                        if(icon) icon.innerHTML = 'â–º';
                    } catch (error) {
                        console.error('åŠ è½½å­ç›®å½•å¤±è´¥:', error);
                        if(icon) icon.textContent = '!';
                    }
                }
            }
            
            async function performContentSearch() {
                const query = dom.contentSearchInput.value.trim();
                const engine = dom.searchEngineSelect.value;
                if (!state.currentRepoId || !query) {
                    return alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä»“åº“å¹¶è¾“å…¥æœç´¢å†…å®¹ã€‚');
                }
                render.status('æ­£åœ¨æœç´¢å†…å®¹...');
                try {
                    const results = await api.searchContent(state.currentRepoId, query, engine);
                    dom.listPanel.innerHTML = render.contentSearchResults(results);
                } catch (error) {
                    console.error('å†…å®¹æœç´¢å¤±è´¥:', error);
                    render.status('å†…å®¹æœç´¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡ã€‚');
                }
            }

            async function performFileSearch() {
                const query = dom.fileSearchInput.value.trim();
                const engine = dom.searchEngineSelect.value;
                if (!state.currentRepoId) return;
                if (!query) {
                    await loadAndRenderRootTree();
                    return;
                }
                render.status('æ­£åœ¨æœç´¢æ–‡ä»¶å...');
                try {
                    const results = await api.searchFiles(state.currentRepoId, query, engine);
                    dom.listPanel.innerHTML = render.fileSearchResults(results);
                } catch (error) {
                    console.error('æ–‡ä»¶åæœç´¢å¤±è´¥:', error);
                    render.status('æ–‡ä»¶åæœç´¢å¤±è´¥ã€‚');
                }
            }

            async function handleCodeClick(event) {
                // æ£€æŸ¥ Ctrl / Cmd é”®
                if (!event.ctrlKey && !event.metaKey) return;

                // æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨ caretRangeFromPoint æ›¿ä»£ getSelection
                // è¿™èƒ½ç²¾ç¡®è·å–ç‚¹å‡»ä½ç½®çš„æ–‡æœ¬åç§»é‡ï¼Œä¸å— Prism DOM ç»“æ„å½±å“
                const position = utils.getClickPosition(dom.fileContentCode, event);
                
                if (!position) {
                    console.log("æ— æ³•è¯†åˆ«ç‚¹å‡»ä½ç½®");
                    return;
                }

                console.log("ç‚¹å‡»ä½ç½®:", position);
                dom.fileContentCode.style.cursor = 'wait';
                render.toast("æ­£åœ¨æŸ¥æ‰¾å®šä¹‰...");

                try {
                    const results = await api.getDefinition(state.currentRepoId, state.currentFilePath, position.line, position.character);
                    dom.fileContentCode.style.cursor = 'text';

                    if (results && results.length > 0) {
                        const def = results[0];
                        if (def.source === 'search') {
                            render.toast("æ¨¡ç³Šè·³è½¬ (åŸºäºæœç´¢)");
                        } else {
                            console.log("ç²¾ç¡®è·³è½¬ (SCIP)");
                            render.toast("è·³è½¬åˆ°å®šä¹‰");
                        }

                        if (def.repoId !== state.currentRepoId) {
                            alert(`å®šä¹‰ä½äºå¦ä¸€ä¸ªä»“åº“: ${def.repoId} (æš‚ä¸æ”¯æŒè‡ªåŠ¨åˆ‡æ¢)`);
                            return;
                        }
                        await loadFileContent(def.filePath, def.range.startLine);
                    } else {
                        // å°è¯•å¼•ç”¨
                        dom.fileContentCode.style.cursor = 'wait';
                        const refs = await api.getReferences(state.currentRepoId, state.currentFilePath, position.line, position.character);
                        dom.fileContentCode.style.cursor = 'text';
                        if (refs && refs.length > 0) {
                            const ref = refs[0];
                            render.toast("è·³è½¬åˆ°å¼•ç”¨");
                            if (ref.repoId !== state.currentRepoId) {
                                alert(`ç›®æ ‡ä½äºå¦ä¸€ä¸ªä»“åº“: ${ref.repoId} (æš‚ä¸æ”¯æŒè‡ªåŠ¨åˆ‡æ¢)`);
                                return;
                            }
                            await loadFileContent(ref.filePath, ref.range.startLine);
                        } else {
                            render.toast("æœªæ‰¾åˆ°å®šä¹‰æˆ–å¼•ç”¨");
                        }
                    }
                } catch (error) {
                    dom.fileContentCode.style.cursor = 'text';
                    console.error("è·å–å®šä¹‰å¤±è´¥:", error);
                    render.toast("è·å–å®šä¹‰å¤±è´¥");
                }
            }


            // --- 6. UTILITIES ---
            const utils = {
                clearFileContent() {
                    dom.fileContentPlaceholder.style.display = 'block';
                    dom.fileContentPre.style.display = 'none';
                    if (state.selectedFileElement) {
                        state.selectedFileElement.classList.remove('selected');
                        state.selectedFileElement = null;
                    }
                    state.currentFilePath = null;
                    dom.filePathInput.value = '';
                },
                getLanguageFromPath(path) {
                    const extension = path.split('.').pop().toLowerCase();
                    const langMap = { 'js': 'javascript', 'ts': 'typescript', 'py': 'python', 'go': 'go', 'java': 'java', 'c': 'c', 'cpp': 'cpp', 'cs': 'csharp', 'html': 'html', 'css': 'css', 'scss': 'scss', 'json': 'json', 'md': 'markdown', 'sh': 'bash', 'yaml': 'yaml', 'yml': 'yaml', 'rb': 'ruby', 'php': 'php', 'rs': 'rust', 'kt': 'kotlin' };
                    return langMap[extension] || 'plaintext';
                },
                scrollToLine(lineNumber) {
                    const codeLines = dom.fileContentCode.innerHTML.split('\n');
                    if (lineNumber > codeLines.length) return;
                    codeLines[lineNumber - 1] = `<span class="line-highlight">${codeLines[lineNumber - 1]}</span>`;
                    dom.fileContentCode.innerHTML = codeLines.join('\n');
                    const highlightedLine = dom.fileContentCode.querySelector('.line-highlight');
                    if (highlightedLine) {
                        highlightedLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                },
                updateSelection(newElement) {
                    if (state.selectedFileElement) {
                        state.selectedFileElement.classList.remove('selected');
                    }
                    state.selectedFileElement = newElement;
                    state.selectedFileElement.classList.add('selected');
                },
                escapeHtml(unsafe) {
                    if (unsafe === null || unsafe === undefined) return '';
                    return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
                },

                // â˜…â˜…â˜… æ–°å¢è¾…åŠ©å‡½æ•°: é«˜äº®ç‰‡æ®µ â˜…â˜…â˜…
                highlightFragments(lineText, fragments) {
                    const esc = utils.escapeHtml; // åˆ«å
                    if (!fragments || fragments.length === 0) {
                        return esc(lineText);
                    }
                    
                    // æŒ‰åç§»é‡æ’åºï¼Œç¡®ä¿æˆ‘ä»¬æŒ‰é¡ºåºå¤„ç†
                    fragments.sort((a, b) => a.offset - b.offset);
                    
                    let resultHtml = '';
                    let lastIndex = 0;
                    
                    for (const frag of fragments) {
                        // æ·»åŠ åŒ¹é…å‰çš„å®‰å…¨æ–‡æœ¬
                        resultHtml += esc(lineText.substring(lastIndex, frag.offset));
                        // æ·»åŠ é«˜äº®çš„åŒ¹é…æ–‡æœ¬
                        resultHtml += `<span class="search-highlight">${esc(lineText.substring(frag.offset, frag.offset + frag.length))}</span>`;
                        lastIndex = frag.offset + frag.length;
                    }
                    // æ·»åŠ æœ€åä¸€ä¸ªåŒ¹é…åçš„å‰©ä½™æ–‡æœ¬
                    resultHtml += esc(lineText.substring(lastIndex));
                    
                    return resultHtml;
                },

                // â˜…â˜…â˜… æ–°å¢: åŸºäºç‰©ç†åæ ‡çš„ç‚¹å‡»ä½ç½®è®¡ç®— â˜…â˜…â˜…
                getClickPosition(element, event) {
                    let range;
                    // æ ‡å‡† API: caretRangeFromPoint (Chrome, Safari, Edge)
                    if (document.caretRangeFromPoint) {
                        range = document.caretRangeFromPoint(event.clientX, event.clientY);
                    } 
                    // Firefox API: caretPositionFromPoint
                    else if (document.caretPositionFromPoint) {
                        const pos = document.caretPositionFromPoint(event.clientX, event.clientY);
                        if (pos) {
                            range = document.createRange();
                            range.setStart(pos.offsetNode, pos.offset);
                            range.collapse(true);
                        }
                    }

                    // ç¡®ä¿ç‚¹å‡»åœ¨ä»£ç åŒºåŸŸå†…
                    if (!range || !element.contains(range.startContainer)) {
                        return null;
                    }

                    // åˆ›å»ºä¸€ä¸ªä»ä»£ç èµ·å§‹ç‚¹åˆ°ç‚¹å‡»ç‚¹çš„ Range
                    const preCaretRange = range.cloneRange();
                    preCaretRange.selectNodeContents(element);
                    preCaretRange.setEnd(range.startContainer, range.startOffset);
                    
                    // è·å–çº¯æ–‡æœ¬åç§»é‡
                    const offset = preCaretRange.toString().length;
                    const textContent = element.textContent;
                    
                    // è®¡ç®—è¡Œå·å’Œåˆ—å·
                    // æ³¨æ„ï¼šè¿™é‡Œçš„ç®—æ³•å‡è®¾æ¢è¡Œç¬¦æ˜¯ \nã€‚Prism é«˜äº®åé€šå¸¸ä¸ä¼šæ”¹å˜æ–‡æœ¬çš„æ¢è¡Œç»“æ„ã€‚
                    let line = 0;
                    let character = 0;
                    let currentOffset = 0;

                    for (let i = 0; i < textContent.length; i++) {
                        if (currentOffset === offset) break;
                        if (textContent[i] === '\n') {
                            line++;
                            character = 0;
                        } else {
                            character++;
                        }
                        currentOffset++;
                    }
                    
                    return { line, character };
                }
            };

            // --- 7. INITIALIZATION ---
            function init() {
                dom.repoSelect.addEventListener('change', handleRepoChange);
                dom.contentSearchButton.addEventListener('click', performContentSearch);
                dom.contentSearchInput.addEventListener('keypress', (e) => e.key === 'Enter' && performContentSearch());
                dom.fileSearchInput.addEventListener('input', () => {
                    clearTimeout(state.fileSearchDebounceTimer);
                    state.fileSearchDebounceTimer = setTimeout(performFileSearch, 300);
                });
                
                dom.settingsBtn.addEventListener('click', () => {
                    const newUrl = prompt('è¯·è¾“å…¥åç«¯ API æœåŠ¡åœ°å€:', api.BASE_URL);
                    if (newUrl) {
                        api.setBaseUrl(newUrl.trim());
                        alert('API åœ°å€å·²æ›´æ–°ã€‚æ­£åœ¨é‡æ–°åŠ è½½ä»“åº“åˆ—è¡¨ã€‚');
                        api.getRepositories()
                           .then(render.repositories)
                           .catch(err => render.status(`è¿æ¥æ–°åœ°å€å¤±è´¥: ${err.message}`));
                    }
                });

                dom.focusFileBtn.addEventListener('click', () => {
                    if (state.currentFilePath) {
                        expandTreeToPath(state.currentFilePath);
                    } else {
                        alert('è¯·å…ˆæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ã€‚');
                    }
                });
                
                dom.filePathInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const newPath = dom.filePathInput.value.trim();
                        if(newPath && state.currentRepoId) {
                            loadFileContent(newPath);
                        }
                    }
                });

                dom.listPanel.addEventListener('click', (e) => {
                    const item = e.target.closest('[data-path], [data-action]');
                    if (!item) return;

                    const action = item.dataset.action;
                    if (action === 'back-to-tree') {
                        loadAndRenderRootTree();
                        return;
                    }

                    const path = item.dataset.path;
                    const type = item.dataset.type;
                    const line = item.dataset.line;

                    if (type === 'directory') {
                        handleDirClick(item, path);
                    } else if (type === 'file') {
                        utils.updateSelection(item);
                        loadFileContent(path);
                    } else if (line) {
                        if(state.selectedFileElement) {
                           state.selectedFileElement.classList.remove('selected');
                        }
                        loadFileContent(path, line);
                    }
                });

                // â˜…â˜…â˜… æ³¨å†Œä»£ç ç‚¹å‡»äº‹ä»¶ â˜…â˜…â˜…
                dom.fileContentCode.addEventListener('click', handleCodeClick);

                // Initial Load

                api.getRepositories()
                    .then(render.repositories)
                    .catch(err => {
                        console.error('åŠ è½½ä»“åº“åˆ—è¡¨å¤±è´¥:', err);
                        render.status(`åŠ è½½ä»“åº“åˆ—è¡¨å¤±è´¥: ${err.message}\nè¯·ç‚¹å‡»å³ä¸Šè§’ âš™ï¸ æ£€æŸ¥æœåŠ¡åœ°å€ã€‚`);
                    });
                render.status('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªä»“åº“');
            }

            return { init };
        })();

        document.addEventListener('DOMContentLoaded', App.init);
    </script>
</body>
</html>
