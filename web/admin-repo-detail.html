<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»“åº“è¯¦æƒ…ç®¡ç† - Code Browser</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --main-bg: #1a202c; --card-bg: #2d3748; --border-color: #4a5568; --text-color: #e2e8f0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--main-bg); color: var(--text-color); }
        .card { background-color: var(--card-bg); border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem; }
        .input-dark { background-color: #4a5568; border: 1px solid #718096; color: white; padding: 0.5rem; border-radius: 0.25rem; width: 100%; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.25rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        .btn-primary { background-color: #4299e1; color: white; }
        .btn-primary:hover { background-color: #3182ce; }
        .btn-success { background-color: #48bb78; color: white; }
        .btn-success:hover { background-color: #38a169; }
        .btn-secondary { background-color: #718096; color: white; }
        .btn-secondary:hover { background-color: #4a5568; }
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 50; left: 50%; bottom: 30px; opacity: 0; transition: opacity 0.5s; }
        #toast.show { visibility: visible; opacity: 1; }
        code { background-color: #111; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-family: monospace; color: #fbbf24; }
    </style>
</head>
<body class="p-8">

    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-8 pb-4 border-b border-gray-600">
            <h1 class="text-3xl font-bold">ä»“åº“è¯¦æƒ…ç®¡ç†</h1>
            <a href="/admin.html" class="text-blue-400 hover:text-blue-300">â† è¿”å›åˆ—è¡¨</a>
        </header>

        <div id="loading" class="text-center text-gray-400 text-xl py-10">æ­£åœ¨åŠ è½½...</div>

        <div id="repo-content" style="display: none;">
            <!-- Basic Info -->
            <div class="card">
                <h2 class="text-xl mb-4 font-semibold border-b border-gray-600 pb-2">åŸºæœ¬ä¿¡æ¯</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div><span class="text-gray-400">ID:</span> <span id="repo-id" class="font-mono ml-2"></span></div>
                    <div><span class="text-gray-400">åç§°:</span> <span id="repo-name" class="font-bold ml-2 text-blue-300"></span></div>
                    <div class="col-span-2"><span class="text-gray-400">æºç è·¯å¾„:</span> <span id="repo-path" class="font-mono ml-2"></span></div>
                </div>
            </div>

            <!-- Auto Indexing -->
            <div class="card">
                <h2 class="text-xl mb-4 font-semibold border-b border-gray-600 pb-2">è‡ªåŠ¨ç´¢å¼• (Zoekt)</h2>
                <p class="mb-4 text-sm text-gray-300">é€šè¿‡åå°è¿›ç¨‹ç›´æ¥æ‰«ææºç ç›®å½•ç”Ÿæˆç´¢å¼•ã€‚é€‚ç”¨äºæœ¬åœ°å¼€å‘æˆ–æºç ä¸æœåŠ¡åœ¨åŒä¸€æœºå™¨çš„åœºæ™¯ã€‚</p>
                <button id="btn-trigger-index" class="btn btn-success">ç«‹å³è§¦å‘è‡ªåŠ¨ç´¢å¼•</button>
            </div>

            <!-- Manual Indexing Guide -->
            <div class="card">
                <h2 class="text-xl mb-4 font-semibold border-b border-gray-600 pb-2">æ‰‹åŠ¨å¯¼å…¥ Zoekt ç´¢å¼•</h2>
                
                <div class="bg-gray-800 p-4 rounded mb-6 text-sm">
                    <h3 class="font-bold text-yellow-500 mb-2">ğŸ’¡ æ“ä½œæŒ‡å—</h3>
                    <p class="mb-2">å¦‚æœä»“åº“éå¸¸åºå¤§ï¼Œå»ºè®®åœ¨é«˜æ€§èƒ½æœºå™¨ä¸Šç”Ÿæˆç´¢å¼•ï¼Œç„¶åå°†æ–‡ä»¶ä¼ è¾“åˆ°æ­¤æœåŠ¡å™¨ã€‚</p>
                    <ol class="list-decimal list-inside space-y-1 text-gray-300 mb-4">
                        <li>åœ¨ç›®æ ‡æœºå™¨å®‰è£… <code class="text-xs">zoekt-git-index</code></li>
                        <li>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆç´¢å¼•ï¼š</li>
                    </ol>
                    <pre class="bg-black p-3 rounded text-green-400 overflow-x-auto mb-4 select-all cursor-text"><code id="manual-index-cmd" class="bg-transparent text-green-400 p-0"></code></pre>
                    <ol class="list-decimal list-inside space-y-1 text-gray-300" start="3">
                        <li>ä¸Šè¿°å‘½ä»¤ä¼šç”Ÿæˆå¤šä¸ªåˆ†ç‰‡æ–‡ä»¶ï¼Œä¾‹å¦‚ <code id="example-shard-name">...00000.zoekt</code></li>
                        <li>å°†è¿™äº›æ–‡ä»¶ä¸Šä¼ åˆ°æœ¬æœåŠ¡å™¨çš„æŸä¸ªä¸´æ—¶ç›®å½•</li>
                        <li>åœ¨ä¸‹æ–¹è¾“å…¥æ‰€æœ‰æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</li>
                    </ol>
                </div>

                <div class="mb-4">
                    <label class="block text-sm mb-2 font-medium">ç´¢å¼•æ–‡ä»¶è·¯å¾„ (æ¯è¡Œä¸€ä¸ªç»å¯¹è·¯å¾„)</label>
                    <textarea id="zoekt-paths-input" class="input-dark font-mono text-sm" rows="5" placeholder="/tmp/upload/myrepo.00000.zoekt&#10;/tmp/upload/myrepo.00001.zoekt"></textarea>
                </div>
                <button id="btn-register-zoekt" class="btn btn-primary">å¯¼å…¥ç´¢å¼•æ–‡ä»¶</button>
            </div>

            <!-- SCIP Indexing -->
            <div class="card">
                <h2 class="text-xl mb-4 font-semibold border-b border-gray-600 pb-2">SCIP æ™ºèƒ½ç´¢å¼•</h2>
                <p class="mb-4 text-sm text-gray-300">SCIP ç´¢å¼•ç”¨äºç²¾ç¡®çš„â€œè·³è½¬åˆ°å®šä¹‰â€å’Œâ€œæŸ¥æ‰¾å¼•ç”¨â€ã€‚éœ€ä½¿ç”¨ç›¸åº”è¯­è¨€çš„ scip ç´¢å¼•å™¨ç”Ÿæˆã€‚</p>
                <div class="flex gap-4 items-end">
                    <div class="flex-grow">
                        <label class="block text-sm mb-1">SCIP æ–‡ä»¶è·¯å¾„ (index.scip)</label>
                        <input type="text" id="scip-path-input" class="input-dark" placeholder="/path/to/index.scip">
                    </div>
                    <button id="btn-register-scip" class="btn btn-secondary">æ³¨å†Œ SCIP</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast"></div>

    <script>
        const API_BASE = 'http://localhost:8088/api';
        const urlParams = new URLSearchParams(window.location.search);
        const repoID = urlParams.get('id');
        const token = localStorage.getItem('adminToken');

        // DOM
        const dom = {
            loading: document.getElementById('loading'),
            content: document.getElementById('repo-content'),
            repoId: document.getElementById('repo-id'),
            repoName: document.getElementById('repo-name'),
            repoPath: document.getElementById('repo-path'),
            toast: document.getElementById('toast'),
            zoektInput: document.getElementById('zoekt-paths-input'),
            scipInput: document.getElementById('scip-path-input'),
            btnTrigger: document.getElementById('btn-trigger-index'),
            btnRegisterZoekt: document.getElementById('btn-register-zoekt'),
            btnRegisterScip: document.getElementById('btn-register-scip'),
        };

        if (!token) {
            window.location.href = '/admin.html';
        }

        async function fetchAPI(endpoint, options = {}) {
            const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, ...options.headers };
            try {
                const res = await fetch(`${API_BASE}${endpoint}`, { ...options, headers });
                if (res.status === 401) {
                    alert('é‰´æƒå¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
                    window.location.href = '/admin.html';
                    return null;
                }
                if (!res.ok) throw new Error(await res.text());
                return res;
            } catch (err) {
                showToast(`é”™è¯¯: ${err.message}`);
                throw err;
            }
        }

        async function init() {
            if (!repoID) {
                alert('ç¼ºå°‘ä»“åº“ ID');
                window.location.href = '/admin.html';
                return;
            }

            try {
                // Get all repos and find current one (since we don't have get-single-repo api yet)
                const res = await fetchAPI('/admin/repositories');
                const repos = await res.json();
                const repo = repos.find(r => r.id == repoID);
                
                if (!repo) throw new Error('ä»“åº“ä¸å­˜åœ¨');

                dom.repoId.textContent = repo.id;
                dom.repoName.textContent = repo.name;
                dom.repoPath.textContent = repo.path || 'N/A';
                
                // Generate manual commands
                const sanitizedName = repo.name.replace(/[^a-zA-Z0-9]+/g, '_');
                const zoektName = repo.id.toString().padStart(10, '0') + '_' + sanitizedName;
                const cmd = `# è¿›å…¥ä»“åº“ç›®å½•
cd /path/to/your/repo

# é…ç½® Zoekt å…ƒæ•°æ® (å¿…é¡»)
git config zoekt.repoid ${repo.id}
git config zoekt.name ${zoektName}

# ç”Ÿæˆç´¢å¼• (åœ¨å½“å‰ç›®å½•ç”Ÿæˆ)
zoekt-git-index -index . .`;
                
                document.getElementById('manual-index-cmd').textContent = cmd;
                document.getElementById('example-shard-name').textContent = `${zoektName}.00000.zoekt`;

                dom.loading.style.display = 'none';
                dom.content.style.display = 'block';
            } catch (err) {
                dom.loading.textContent = `åŠ è½½å¤±è´¥: ${err.message}`;
            }
        }

        function showToast(msg) {
            dom.toast.textContent = msg;
            dom.toast.classList.add("show");
            setTimeout(() => { dom.toast.classList.remove("show"); }, 3000);
        }

        // --- Event Handlers ---

        dom.btnTrigger.addEventListener('click', async () => {
            if(!confirm('ç¡®å®šè¦å¼€å§‹è‡ªåŠ¨ç´¢å¼•å—ï¼Ÿè¿™å¯èƒ½ä¼šæ¶ˆè€—å¤§é‡ CPU èµ„æºã€‚')) return;
            try {
                await fetchAPI(`/repositories/${repoID}/index`, { method: 'POST' });
                showToast('ç´¢å¼•ä»»åŠ¡å·²å¯åŠ¨');
            } catch(e) {}
        });

        dom.btnRegisterZoekt.addEventListener('click', async () => {
            const text = dom.zoektInput.value.trim();
            if (!text) return alert('è¯·è¾“å…¥ç´¢å¼•æ–‡ä»¶è·¯å¾„');
            
            const paths = text.split('\n').map(p => p.trim()).filter(p => p);
            if (paths.length === 0) return;

            try {
                await fetchAPI(`/repositories/${repoID}/zoekt-file`, {
                    method: 'POST',
                    body: JSON.stringify({ paths })
                });
                showToast(`æˆåŠŸå¯¼å…¥ ${paths.length} ä¸ªç´¢å¼•æ–‡ä»¶`);
                dom.zoektInput.value = '';
            } catch(e) {}
        });

        dom.btnRegisterScip.addEventListener('click', async () => {
            const path = dom.scipInput.value.trim();
            if (!path) return alert('è¯·è¾“å…¥ SCIP æ–‡ä»¶è·¯å¾„');

            try {
                await fetchAPI(`/repositories/${repoID}/scip`, {
                    method: 'POST',
                    body: JSON.stringify({ path })
                });
                showToast('SCIP ç´¢å¼•æ³¨å†ŒæˆåŠŸ');
                dom.scipInput.value = '';
            } catch(e) {}
        });

        init();
    </script>
</body>
</html>
